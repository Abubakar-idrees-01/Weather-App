{% extends "weather/base.html" %}

{% block title %}SkyCast | Intelligence{% endblock %}

{% block content %}
<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.15);
        --text-main: #ffffff;
        --accent-blue: #4facfe;
        --blur: 20px;
        --bg-gradient: linear-gradient(-45deg, #0f2027, #203a43, #2c5364);
    }

    [data-theme="light"] {
        --glass-bg: rgba(255, 255, 255, 0.6);
        --glass-border: rgba(0, 0, 0, 0.1);
        --text-main: #2d3436;
        --bg-gradient: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #f1f2f6);
    }

    body {
        margin: 0; min-height: 100vh;
        background: var(--bg-gradient);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        color: var(--text-main);
        transition: all 0.4s ease;
        font-family: 'Inter', sans-serif;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .dashboard-container { padding: 1.5rem; max-width: 1100px; margin: auto; }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur));
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
    }

    /* Search & Location Group */
    .search-wrapper {
        display: flex; gap: 10px; align-items: center;
    }
    
    .input-group-custom {
        flex-grow: 1; position: relative;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 14px;
        display: flex; align-items: center; padding: 5px 15px;
    }

    #cityInput {
        background: transparent !important; border: none !important;
        color: var(--text-main) !important; padding: 10px; width: 100%;
    }

    .btn-location {
        background: transparent; border: none; color: var(--accent-blue);
        font-size: 1.2rem; cursor: pointer; transition: 0.3s;
    }
    .btn-location:hover { transform: scale(1.1); color: #fff; }

    .btn-action {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        color: white; border: none; border-radius: 14px;
        padding: 12px 25px; font-weight: 600;
    }

    /* Hourly Section */
    .hourly-scroll {
        display: flex; gap: 1rem; overflow-x: auto; padding: 10px 5px; scrollbar-width: none;
    }
    .hourly-scroll::-webkit-scrollbar { display: none; }

    .hourly-card {
        min-width: 105px; padding: 1rem; text-align: center;
        background: var(--glass-bg); border: 1px solid var(--glass-border);
        border-radius: 20px; flex-shrink: 0;
    }

    .display-temp { font-size: 3.5rem; font-weight: 800; line-height: 1; }
    
    .theme-switch {
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        cursor: pointer; padding: 8px 12px; border-radius: 50px;
        background: var(--glass-bg); border: 1px solid var(--glass-border);
    }

    #loader { display: none; }
</style>

<div class="theme-switch" onclick="toggleTheme()">
    <span id="theme-icon">üåô</span>
</div>

<div class="dashboard-container">
    <div class="glass-card p-3 mb-4">
        <form method="POST" id="weatherForm">
            {% csrf_token %}
            <div class="search-wrapper">
                <div class="input-group-custom">
                    <input type="text" name="city" id="cityInput" list="citySuggestions" 
                           placeholder="Search city..." autocomplete="off" required>
                    <button type="button" class="btn-location" onclick="getLocation()" title="Use my location">
                        üìç
                    </button>
                    <datalist id="citySuggestions"></datalist>
                </div>
                <button type="submit" class="btn-action">Search</button>
            </div>
        </form>
        <div id="loader" class="text-center mt-2">
            <div class="spinner-border spinner-border-sm text-info"></div>
            <span class="ms-2 small opacity-75">Fetching data...</span>
        </div>
    </div>

    {% if error %}
    <div class="alert glass-card text-center text-danger p-3 mb-4">{{ error }}</div>
    {% endif %}

    {% if weather %}
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="glass-card h-100 p-4 text-center d-flex flex-column justify-content-center">
                <h5 class="opacity-50 text-uppercase small mb-1">{{ weather.country }}</h5>
                <h2 class="fw-bold mb-3">{{ weather.city }}</h2>
                <div class="my-3">
                    <img src="https:{{ weather.icon }}" alt="weather-icon" style="width: 100px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));">
                    <div class="display-temp mt-2">{{ weather.temp|floatformat:0 }}¬∞</div>
                </div>
                <p class="fs-5 fw-light text-capitalize mb-0">{{ weather.condition }}</p>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="glass-card h-100 p-4">
                <div class="row g-2 text-center mb-4">
                    <div class="col-3">
                        <div class="stat-box p-2 rounded" style="background: rgba(255,255,255,0.05);">
                            <small class="d-block opacity-50">Feels</small>
                            <span class="fw-bold">{{ weather.feels_like|floatformat:0 }}¬∞</span>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box p-2 rounded" style="background: rgba(255,255,255,0.05);">
                            <small class="d-block opacity-50">Humid</small>
                            <span class="fw-bold">{{ weather.humidity }}%</span>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box p-2 rounded" style="background: rgba(255,255,255,0.05);">
                            <small class="d-block opacity-50">Wind</small>
                            <span class="fw-bold">{{ weather.wind|floatformat:0 }}</span>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="stat-box p-2 rounded" style="background: rgba(255,255,255,0.05);">
                            <small class="d-block opacity-50">Pres</small>
                            <span class="fw-bold">{{ weather.pressure|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>
                <div style="height: 180px;">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-12 mt-2">
            <div class="d-flex justify-content-between align-items-end mb-3">
                <h5 class="mb-0">Hourly Timeline</h5>
                <small class="opacity-50">Next 48 Hours</small>
            </div>
            <div class="hourly-scroll">
                {% for hour in hourly_cards %}
                <div class="hourly-card">
                    <small class="d-block opacity-50 mb-2">{{ hour.time }}</small>
                    <img src="https:{{ hour.icon }}" width="40" class="mx-auto d-block">
                    <div class="fw-bold mt-2">{{ hour.temp|floatformat:0 }}¬∞</div>
                    <small style="font-size: 0.65rem;" class="opacity-75 d-block text-truncate">{{ hour.cond }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Get Current Location Logic
    function getLocation() {
        const loader = document.getElementById('loader');
        if (navigator.geolocation) {
            loader.style.display = 'block';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    // Pass coordinates as the city to WeatherAPI (it supports lat,lon)
                    document.getElementById('cityInput').value = `${lat},${lon}`;
                    document.getElementById('weatherForm').submit();
                },
                (error) => {
                    loader.style.display = 'none';
                    alert("Unable to retrieve location. Please type manually.");
                }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }

    // 2. City Suggestion Engine
    const cityInput = document.getElementById('cityInput');
    const dataList = document.getElementById('citySuggestions');

    cityInput.addEventListener('input', async (e) => {
        const query = e.target.value;
        if (query.length < 3) return;
        try {
            const response = await fetch(`/city-suggestions/?q=${query}`);
            const cities = await response.json();
            dataList.innerHTML = '';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                dataList.appendChild(option);
            });
        } catch (err) { console.warn("Autocomplete service error"); }
    });

    // 3. Theme Toggle
    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('theme-icon');
        if (body.getAttribute('data-theme') === 'light') {
            body.removeAttribute('data-theme');
            icon.innerText = 'üåô';
        } else {
            body.setAttribute('data-theme', 'light');
            icon.innerText = '‚òÄÔ∏è';
        }
    }

    // 4. Chart Logic
    {% if chart_values %}
    const ctx = document.getElementById('forecastChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                data: {{ chart_values|safe }},
                borderColor: '#4facfe',
                backgroundColor: 'rgba(79, 172, 254, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                borderWidth: 2
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'gray', font: {size: 10}} },
                x: { grid: { display: false }, ticks: { color: 'gray', font: {size: 10}} }
            }
        }
    });
    {% endif %}

    document.getElementById('weatherForm').onsubmit = () => {
        document.getElementById('loader').style.display = 'block';
    };
</script>
{% endblock %}